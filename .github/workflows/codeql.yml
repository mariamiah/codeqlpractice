name: codeql workflow
on:
  push:
    branches:
      - main
      - master
      - develop
      - test/update

jobs:
  create-language-build-config:
    name: Create language build config
    runs-on: ubuntu-latest
    outputs:
      build-config: ${{ steps.create-build-config.outputs.build_config }}
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - id: create-build-config
        name: Create build config
        run: |
          mkdir -p .github/codeql
          echo '["java-kotlin","javascript"]' | jq -c '
            map({"language": ., "build-mode": "auto"}) |
            map(if .language == "java-kotlin" 
                then .["build-mode"] = "manual" | .["build-script"] = "./gradlew --no-daemon -Dorg.gradle.jvmargs=-Xmx2g clean compileJava compileTestJava"
                else .
                end)' > .github/codeql/build-config.json
          ls -la && cat .github/codeql/build-config.json
        shell: bash

  codeql:
    name: CodeQL
    needs: create-language-build-config
    permissions:
      actions: read
      contents: read
      security-events: write
    uses: Kynetixx/codeql-module/.github/workflows/codeql-analysis.yml@main
    with:
      build-config: .github/codeql/build-config.json
