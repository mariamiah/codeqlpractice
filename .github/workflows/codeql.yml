name: codeql workflow
on:
  push:
    branches:
      - main
      - master
      - develop
      - test/update

jobs:
  create-language-build-config:
    name: Create language build config
    runs-on: ubuntu-latest
    outputs:
      build-config: ${{ steps.create-build-config.outputs.build_config }}
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - id: create-build-config
        name: Create build config
        run: >
          echo '${{ steps.transform-language-names.outputs.TRANSFORMED-LANGUAGES }}' |
          jq 'map({"language": ., "build-mode": "auto"}) |
          map(if .language == "java-kotlin" 
          then ."build-mode" = "manual" | ."build-script" = "./gradlew --no-daemon -Dorg.gradle.jvmargs=-Xmx2g clean compileJava compileTestJava"
          else . end)' > build-config.json
        shell: bash
      - name: Upload build config
        uses: actions/upload-artifact@v2
        with:
          name: build-config
          path: build-config.json


  codeql:
    name: CodeQL
    runs-on: ubuntu-latest
    needs: create-language-build-config
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Download build config
      uses: actions/download-artifact@v2
      with:
        name: build-config
        path: .
  
    - name: Use build config
      uses: Kynetixx/codeql-module/.github/workflows/codeql-analysis.yml@main
      with:
        build-config: build-config.json
